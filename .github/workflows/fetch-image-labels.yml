---

name: fetch-image-labels

on:
  workflow_dispatch: {}
  push:
    paths:
      - .github/workflows/fetch-image-labels.yml

jobs:
  query-dockerhub:
    runs-on: ubuntu-latest
    steps:
      - run: |
          repo=delnaught/mythtv-backend
          tag=32
          token=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${repo}:pull" | jq -r '.token')
          digest=$(curl -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
          -H "Authorization: Bearer $token" \
          -s "https://registry-1.docker.io/v2/${repo}/manifests/${tag}" \
          | jq -r .config.digest)
          curl -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
          -H "Authorization: Bearer $token" \
          -s -L "https://registry-1.docker.io/v2/${repo}/blobs/${digest}" | jq .config.Labels
